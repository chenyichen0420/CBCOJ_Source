<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBCOJ - 私信</title>
    <link rel="stylesheet" href="/assets/base.css">
    <link rel="stylesheet" href="/assets/components.css">
    <link rel="stylesheet" href="/assets/layout.css">
</head>

<body>
    <nav>
        <div class="nav-left">
            <a href="/" class="logo"><img src="/favicon.ico" width="20" height="20"> CBCOJ </a>
            <a href="/problemlist">题库</a>
            <a href="/discussions">讨论</a>
            <a href="/submissionlist">评测列表</a>
            <a href="/chat" style="color: var(--link); text-decoration: underline;">私信</a>
            <a href="/settings">个人设置</a>
        </div>
        <div class="nav-right">
            <div class="login-content">
                <div id="login-area"></div>
                <div id="login-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">正在检测登录状态...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="page">
        <div class="container">
            <h1>私信</h1>
            <div class="setting-layout">
                <div class="left">
                    <h2>发送私信</h2>
                    <div>
                        <label for="targetUser">目标用户:</label><br>
                        <input type="text" id="targetUser" placeholder="输入用户名"><br><br>
                        <label for="messageContent">消息内容:</label><br>
                        <textarea id="messageContent" rows="4" cols="50" placeholder="输入消息内容"></textarea><br><br>
                        <button id="sendMessageBtn">发送消息</button>
                    </div>
                    <div id="sendStatus" style="margin-top: 10px; color: red;"></div>
                </div>
                <div class="right">
                    <h2>收件箱</h2>
                    <div id="messageList">正在获取消息...</div>
                    <div class="pagination" id="messagePagination"></div>
                </div>
            </div>
    </main>

    <script type="text/javascript" src="/assets/checklogin.js"></script>
    <script>
        checkLogin();

        if (getcookie() === "gunmu") {
            console.log("未登录，返回登录界面");
            window.location.href = "/login";
        }
        
        // HTML 转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 处理换行符，将 \n 转换为 <br>
        function formatContent(text) {
            return escapeHtml(text).replace(/\n/g, '<br>');
        }
        
        function sendMessage() {
            const target = document.getElementById('targetUser').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            
            if (!target || !content) {
                document.getElementById('sendStatus').textContent = '请填写完整信息';
                document.getElementById('sendStatus').style.color = 'red';
                return;
            }
            
            // 对内容进行URL编码
            const encodedContent = encodeURIComponent(content);
            
            getuid(target).then(uid => {
                fetch(BASE_URL + `/api/postmsg?cookie=${getcookie()}&target=${encodeURIComponent(uid)}&content=${encodedContent}`)
                    .then(response => response.text())
                    .then(data => {
                        if (data === "Y") {
                            document.getElementById('sendStatus').textContent = '发送成功';
                            document.getElementById('sendStatus').style.color = 'green';
                            document.getElementById('targetUser').value = '';
                            document.getElementById('messageContent').value = '';
                            
                            // 重新加载消息列表
                            loadMessages(messagePage);
                        } else {
                            document.getElementById('sendStatus').textContent = '发送失败，请重试';
                            document.getElementById('sendStatus').style.color = 'red';
                        }
                    })
                    .catch(error => {
                        document.getElementById('sendStatus').textContent = '网络错误，请重试';
                        document.getElementById('sendStatus').style.color = 'red';
                    });
            })
        }
        
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        
        function loadMessages(page) {
            fetch(BASE_URL + `/api/getmsg?cookie=${getcookie()}&page=${page}`)
                .then(response => response.json())
                .then(data => {
                    if (data[0] !== "Y") {
                        document.getElementById('messageList').textContent = '获取消息失败';
                        return;
                    }
                    
                    const messages = data[1];
                    messages.reverse();
                    const messageListDiv = document.getElementById('messageList');
                    messageListDiv.innerHTML = '';
                    
                    // 如果没有消息
                    if (messages.length === 0) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.textContent = '暂无消息';
                        emptyDiv.className = 'message-item card';
                        emptyDiv.style.padding = '10px';
                        messageListDiv.appendChild(emptyDiv);
                        return;
                    }
                    
                    // 安全地显示每条消息
                    messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'message-item card';
                        div.style.cssText = 'padding: 10px; margin-bottom: 10px;';
                        
                        // 使用DOM方法安全创建元素
                        const header = document.createElement('strong');
                        getusername(msg.uid).then(username => {
                            header.textContent = `来自用户 ${username}:`;
                        });
                        
                        const contentPara = document.createElement('p');
                        // 解码消息内容并进行安全格式化
                        const decodedContent = decodeURIComponent(msg.msg);
                        contentPara.innerHTML = formatContent(decodedContent);
                        
                        const timeSpan = document.createElement('span');
                        timeSpan.className = 'message-time';
                        timeSpan.style.cssText = 'display: block; font-size: 0.8em; color: #666; margin-top: 5px;';
                        
                        // 如果有时间戳，显示时间
                        if (msg.time) {
                            const date = new Date(msg.time * 1000);
                            timeSpan.textContent = `时间: ${date.toLocaleString()}`;
                        }
                        
                        div.appendChild(header);
                        div.appendChild(contentPara);
                        div.appendChild(timeSpan);
                        
                        messageListDiv.appendChild(div);
                    });
                    
                    // 更新分页
                    updatePagination(page, data[2]);
                })
                .catch(error => {
                    console.error('获取消息失败:', error);
                    document.getElementById('messageList').textContent = '网络错误，无法获取消息';
                });
        }
        
        function updatePagination(currentPage, totalPages) {
            const paginationDiv = document.getElementById('messagePagination');
            paginationDiv.innerHTML = '';
            
            // 创建分页链接
            for (let i = Math.max(1, currentPage - 2); i <= totalPages && i <= currentPage + 2; i++) {
                const a = document.createElement('a');
                a.textContent = i;
                
                if (i === currentPage) {
                    a.style.background = 'rgba(78,161,255,.24)';
                } else {
                    // 安全地设置点击事件，避免使用内联onclick
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        loadMessages(i);
                        // 更新URL但不刷新页面
                        const url = new URL(window.location);
                        url.searchParams.set('page', i);
                        window.history.pushState({}, '', url);
                    });
                    
                    a.href = '#';
                }
                
                paginationDiv.appendChild(a);
            }
            
            // 添加"第一页"和"最后一页"链接（可选）
            if (currentPage > 3) {
                const firstLink = document.createElement('a');
                firstLink.textContent = '<<';
                firstLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadMessages(1);
                    window.history.pushState({}, '', '?page=1');
                });
                firstLink.href = '#';
                paginationDiv.insertBefore(firstLink, paginationDiv.firstChild);
            }
            
            if (currentPage < totalPages - 2) {
                const lastLink = document.createElement('a');
                lastLink.textContent = '>>';
                lastLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadMessages(totalPages);
                    window.history.pushState({}, '', `?page=${totalPages}`);
                });
                lastLink.href = '#';
                paginationDiv.appendChild(lastLink);
            }
        }
        
        // 从URL获取当前页码
        const urlParams = new URLSearchParams(window.location.search);
        const messagePage = parseInt(urlParams.get('page'), 10) || 1;
        
        // 初始加载消息
        loadMessages(messagePage);
        
        // 监听浏览器前进/后退按钮
        window.addEventListener('popstate', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const newPage = parseInt(urlParams.get('page'), 10) || 1;
            loadMessages(newPage);
        });
    </script>
</body>

</html>