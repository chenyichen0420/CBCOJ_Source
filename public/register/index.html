<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBCOJ - 打倒 609 暴政，世界属于 606</title>
    <link rel="stylesheet" href="/assets/base.css">
    <link rel="stylesheet" href="/assets/components.css">
    <link rel="stylesheet" href="/assets/layout.css">
</head>

<body>
    <nav>
        <div class="nav-left">
            <a href="/" class="logo"><img src="/favicon.ico" width="20" height="20"> CBCOJ </a>
            <a href="/problemlist">题库</a>
            <a href="/discussions">讨论</a>
            <a href="/submissionlist">评测列表</a>
            <a href="/chat">私信</a>
            <a href="/settings">个人设置</a>
        </div>
        <div class="nav-right">
            <div class="login-content">
                <div id="login-area"></div>
                <div id="login-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">正在检测登录状态...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="page">
        <div class="container">
            <h1> 注册账号 - CBCOJ </h1>
            <div id="content">
                <div class="home-layout">
                    <div class="left card">
                        <h2>🚀 欢迎注册 CBCOJ</h2>
                        <p>请填写以下信息以创建您的 CBCOJ 账号，加入我们一起探索编程的乐趣！</p>

                        <form class="register-form" id="register-form">
                            <div class="form-group">
                                <label for="username">用户名</label>
                                <input type="text" id="username" name="username" required>
                                <label for="password">密码</label>
                                <input type="password" id="password" name="password" required>
                                <label for="luoguuid">洛谷 UID</label>
                                <input type="text" id="luoguuid" name="luoguuid" required>
                                <button type="button" class="btn" id="sendCodeButton">发送验证代码到洛谷</button>
                                <label for="code">验证代码</label>
                                <input type="text" id="code" name="code" required>
                            </div>
                            <button type="submit" class="btn">注册</button>
                        </form>
                    </div>
                    <div class="right card">
                        <h2> 注册流程</h2>
                        <ol>
                            <li>填写注册表单，提供用户名、密码和洛谷 UID</li>
                            <li>在您的洛谷账号上，向<a href="https://www.luogu.com.cn/chat?uid=1061296">指定的用户</a>发送消息“cbcoj-register”（不包含引号）</li>
                            <li>提交注册信息，系统将验证您的信息并创建账号</li>
                            <li>接着，我们将向您的洛谷账号发送验证代码，您需要填入验证代码</li>
                            <li>注册成功后，您可以立即登录并开始使用 CBCOJ 的各种功能</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="text/javascript" src="/assets/checklogin.js"></script>
    <script>
        checkLogin();

        if (getcookie() !== "gunmu" && getcookie() !== "") {
            window.location.href = "/"; // 已登录用户访问注册页，重定向到主页
        }

        let token = "gunmu";

        document.getElementById('sendCodeButton').addEventListener('click', function () {
            const luoguuid = document.getElementById('luoguuid').value;
            if (!luoguuid) {
                alert('请先填写洛谷 UID');
                return;
            }

            fetch(BASE_URL + `/api/genregtoken?uid=${encodeURIComponent(luoguuid)}&usrname=${encodeURIComponent(document.getElementById('username').value)}&paswd=${encodeURIComponent(document.getElementById('password').value)}`)
            .then(response => response.json())
            .then(data => {
                if (data[0] === "Y") {
                    alert('验证代码已发送到您的洛谷账号，请检查消息并填写验证代码。');
                    token = data[1];
                } else {
                    alert('发送验证代码失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('发送验证代码过程中发生错误，请稍后再试。');
            });
        });

        document.getElementById('register-form').addEventListener('submit', function (e) {
            e.preventDefault();
            if (!token || token === "gunmu") {
                alert('请先发送验证代码到洛谷账号');
                return;
            }
            const code = document.getElementById('code').value;

            fetch(BASE_URL + `/api/verifycode?code=${encodeURIComponent(code)}&token=${encodeURIComponent(token)}`)
            .then(data => {
                if (data === "Y") {
                    alert('注册成功！请登录。');
                    window.location.href = '/login';
                } else {
                    alert('注册失败，请重新获取你的验证代码。');
                    token = "gunmu";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('注册过程中发生错误，请稍后再试。');
            });
        });
    </script>
</body>

</html>