<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBCOJ - 个人信息</title>
    <link rel="stylesheet" href="/assets/base.css">
    <link rel="stylesheet" href="/assets/components.css">
    <link rel="stylesheet" href="/assets/layout.css">
</head>

<body>
    <nav>
        <div class="nav-left">
            <a href="/" class="logo"><img src="/favicon.ico" width="20" height="20"> CBCOJ </a>
            <a href="/problemlist">题库</a>
            <a href="/discussions">讨论</a>
            <a href="/submissionlist">评测列表</a>
            <a href="/chat">私信</a>
            <a href="/settings" style="color: var(--link); text-decoration: underline;">个人设置</a>
        </div>
        <div class="nav-right">
            <div class="login-content">
                <div id="login-area"></div>
                <div id="login-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">正在检测登录状态...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="page">
        <div class="container">
            <h1>个人设置</h1>
            <div class="setting-layout content">
                <div class="left card">
                    <h2>修改个人信息</h2>
                    <form id="info-form">
                        <label for="usrname">用户名：</label>
                        <input type="text" id="usrname" name="usrname" value="" required>
                        <label for="pubcode">公开代码：</label>
                        <select id="pubcode" name="pubcode" required
                            style="color: black; background-color: rgba(234, 244, 255, 0.32);">
                            <option value="yes">是</option>
                            <option value="no">否</option>
                        </select>
                        <label for="paswd">密码：</label>
                        <input type="password" id="paswd" name="paswd" required>
                        <button type="submit">修改信息</button>
                    </form>
                    <div id="info-message"></div>
                </div>
                <div class="right card">
                    <h2>注意事项</h2>
                    <ul>
                        <li>用户名不能为空且不能包含特殊字符。</li>
                        <li>密码应至少包含6个字符，建议使用强密码以保障账户安全。</li>
                        <li>公开代码选项决定其他用户是否可以查看您的提交代码。</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
    <script type="text/javascript" src="/assets/checklogin.js"></script>
    <script>
        checkLogin();

        if (getcookie() === 'gunmu') {
            window.location.href = '/login';
        }

        function loadUserInfo() {
            fetch(BASE_URL + `/api/getinfoshort?key=${getcookie()}`)
                .then(response => response.json())
                .then(data => {
                    if (data[0] === 'Y') {
                        document.getElementById('usrname').value = data[1][1];
                        document.getElementById('pubcode').value = data[1][2];
                    } else {
                        console.error('Failed to load user info:', data[1]);
                    }
                });
        }
        async function login() {
            const usrname = document.getElementById('usrname').value;
            const paswd = document.getElementById('paswd').value;
            const response = await fetch(BASE_URL + `/api/login?usrname=${usrname}&paswd=${paswd}`);
            const result = await response.json();
            if (result[0] === 'Y') {
                document.cookie = `user_cookie=${result[1]}; expires=; path=/;`;
            } else {
                console.error(`登陆失败！原因：${result[1]}`);
            }
        }
        loadUserInfo();
        document.getElementById('info-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const usrname = document.getElementById('usrname').value;
            const pubcode = document.getElementById('pubcode').value;
            const paswd = document.getElementById('paswd').value;
            fetch(BASE_URL + `/api/updinfo?cookie=${getcookie()}&usrname=${usrname}&paswd=${paswd}&pubcode=${pubcode}`)
                .then(response => response.text())
                .then(data => {
                    const messageDiv = document.getElementById('info-message');
                    console.log(data);
                    if (data === 'Y') {
                        messageDiv.textContent = '个人信息修改成功！';
                        login();
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1000);
                    } else {
                        messageDiv.textContent = '修改失败！';
                    }
                });
        });
    </script>
</body>

</html>